---
title: "kruskal-wallis + Bonferroni correction"
author: Krifa Sallouha
output:
  html_document:
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
params:
  analysis: One time point
  control: "60000"
  experiments: "12781,13980,14767,16099,22469,24451,24680,25402,2629,26557,26562,27696,27846"  
---

# Initiation
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load all necessary R packages
library(dplyr)
library(readxl)
library(ggpubr)
library(ggsignif)
library(rstudioapi)
library(data.table)
library(stringr)
library(lubridate)
library(grid)
library(ggplot2)
library(reshape2)
library(tidyr)
library(WRS2)
library(svDialogs)
library(kableExtra)
library(xlsx)
library(rstatix)
library(openxlsx) 

```

```{r data setup, include=TRUE}
  

# Prompt user to select folder containing input files
rawdata_folder <- selectDirectory(caption = "Select Folder with rawdata files", label = "rawdata files")
setwd(rawdata_folder)

filelist <- NULL
filelist$csv <- list.files(".", pattern = "\\.csv$", recursive = TRUE)
total <- length(filelist$csv)
if (total == 0) stop("THERE ARE NO CSV FILES IN THE CURRENT LOCATION.")

# Read and combine all CSV files into a single data frame
datalist <- list()
for (f in 1:total) {
  dataframe <- read.csv(filelist$csv[f])
  datalist[[f]] <- dataframe
}
all_data <- rbindlist(datalist)

# Extract experiment date from 'cxd_file'
cxd_files <- unlist(all_data$cxd_file)
all_data <- all_data[, cxd_date := as.Date(mdy(str_extract(cxd_files, "[:digit:]{6}"))), ]

# Get unique genotypes for downstream processing
condition_list <- unique(all_data$CODE)

# Select only relevant cardiac parameters from the dataset
all_data_good_parameters <- all_data %>% select(all_of(c(
  "CODE", "type", "fly_gene", "Age", "EDD", "ESD", "FS", "HP_median",
  "DI_median", "relaxtime", "SI_median", "AI", "SV", "CO", "peaked_median",
  "min.velocity", "max.velocity", "MAD_SI", "MAD_DI", "MAD_HP",
  "tt10r_median", "MAD_tt10r")))

```

```{r Outlier Treatment, include=FALSE}

# Define cardiac parameters to check for outliers
parameters <- c(
  "EDD", "ESD", "FS", "tt10r_median", "MAD_tt10r", "SV", "CO",
  "peaked_median", "min.velocity", "max.velocity", "MAD_SI", 
  "MAD_DI", "MAD_HP", "HR", "HP_median", "DI_median", 
  "relaxtime", "SI_median", "AI"
)

# For each genotype and each parameter, identify and remove outliers (replace with NA)
for (condition in condition_list) {
  for (param in parameters) {
    outlier_val <- boxplot.stats(all_data_good_parameters[[param]][which(all_data_good_parameters$CODE == condition)])$out
    if (length(outlier_val) != 0) {
      all_data_good_parameters[[param]][all_data_good_parameters$CODE == condition & all_data_good_parameters[[param]] %in% outlier_val] <- NA
    }
  }
}

```

```{r Full analysis, echo=TRUE}


# Convert p-values to significance labels (****, ***, **, *, NS)
SignificanceIndice <- function(x) {
  ifelse(x < 0.0001, "****",
         ifelse(x < 0.005, "***",
                ifelse(x < 0.01, "**",
                       ifelse(x < 0.05, "*", "NS"))))
}

# Create an empty dataframe to store statistical results
fold_change_df <- data.frame(
  Parameter = character(),
  Control = numeric(),
  fly_gene = character(),
  Experiment = character(),
  Kruskal_pvalue = numeric(),
  Adjusted_pvalue = numeric(),
  Significance_Index = character(),
  Fold_Change = numeric(),
  Direction = character(),
  stringsAsFactors = FALSE
)

# Define cardiac parameters to analyze
parameter_list <- c("EDD", "ESD", "FS", "HP_median", "SI_median", "DI_median", 
                    "relaxtime", "AI", "SV", "CO", "peaked_median", "min.velocity", 
                    "max.velocity", "MAD_SI", "MAD_DI", "MAD_HP", "tt10r_median", "MAD_tt10r")

# Parse experiment codes from params
experiments <- unlist(strsplit(params$experiments, ","))

# Loop over each parameter
for (i in seq_along(parameter_list)) {
  parameter <- parameter_list[i]

  dataset_1 <- all_data_good_parameters %>%
    select(CODE, fly_gene, !!as.symbol(parameter)) %>%
    filter(CODE %in% c(params$control, experiments)) %>%
    mutate(Parameter = parameter)
  colnames(dataset_1) <- c("CODE", "fly_gene", "value", "Parameter")

  # Compute control mean
  control_mean <- mean(dataset_1$value[dataset_1$CODE == params$control], na.rm = TRUE)

  # Test each experiment vs control using Kruskal-Wallis
  for (j in seq_along(experiments)) {
    experiment <- experiments[j]
    experiment_data <- dataset_1[dataset_1$CODE %in% c(params$control, experiment), ]

    test_result <- kruskal.test(value ~ CODE, data = experiment_data)
    p_value <- test_result$p.value

    fold_change_df <- rbind(fold_change_df, data.frame(
      Parameter = parameter,
      Control = control_mean,
      fly_gene = experiment_data$fly_gene[1],
      experiment = experiment,
      Kruskal_pvalue = p_value,
      Adjusted_pvalue = NA,
      Significance_Index = NA,
      Fold_Change = NA,
      Direction = NA,
      stringsAsFactors = FALSE
    ))
  }

  # Adjust p-values (Bonferroni) for all comparisons within this parameter
  fold_change_df$Adjusted_pvalue[fold_change_df$Parameter == parameter] <- 
    p.adjust(fold_change_df$Kruskal_pvalue[fold_change_df$Parameter == parameter], method = "bonferroni")

  # Assign significance labels
  fold_change_df$Significance_Index[fold_change_df$Parameter == parameter] <- 
    SignificanceIndice(fold_change_df$Adjusted_pvalue[fold_change_df$Parameter == parameter])

  # Compute fold change and direction
  for (j in seq_along(experiments)) {
    experiment <- experiments[j]
    experiment_row <- fold_change_df[fold_change_df$Parameter == parameter & fold_change_df$experiment == experiment, ]

    if (experiment_row$Adjusted_pvalue <= 0.05) {
      experiment_mean <- mean(dataset_1$value[dataset_1$CODE == experiment], na.rm = TRUE)
      fold_change <- experiment_mean / control_mean
      direction <- ifelse(fold_change > 1, "Enhanced phenotype", "Reduced phenotype")
    } else {
      fold_change <- 0
      direction <- "No change"
    }

    fold_change_df$Fold_Change[fold_change_df$Parameter == parameter & fold_change_df$experiment == experiment] <- fold_change
    fold_change_df$Direction[fold_change_df$Parameter == parameter & fold_change_df$experiment == experiment] <- direction
  }
}

fold_change_df$Control <- params$control

# Remove potential duplicates
fold_change_df <- fold_change_df[!duplicated(fold_change_df[c("Parameter", "experiment")]), ]

# Export results to Excel and CSV
write.xlsx(fold_change_df, "fold_change_table_adjusted.xlsx")
write.csv(fold_change_df, "fold_change_table_adjusted.csv", row.names = FALSE)

kbl(fold_change_df) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```
